name: Presubmit

permissions:
  contents: read

# Controls when the action will run.
on:
  push:
  workflow_dispatch:
  pull_request:

# These jobs are potentially parallelizeable
jobs:
  build:
    name: Build spec artifacts
    runs-on: ubuntu-latest
    # needs: checkout
    container: khronosgroup/docker-images@sha256:bd30a83285a2ea062598f053b5bd8ebc843e16c639c0e4cd88ab4bbb4e63ead3

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
          # If fetch-depth: 0 is not specified, then
          #     git describe --tags --dirty
          # below fails.
          # This could also affect SPECREVISION in the Makefile.
          fetch-depth: 0

      # Ownerships in the working directory are odd.
      # . is owned by UID 1001, while repo files are owned by root.
      # This leads to many odd messages like
      #     fatal: detected dubious ownership in repository at '/__w/OpenCL-Docs/OpenCL-Docs'
      # The 'git config' is a brute-force workaround.
      - name: Git safe directory workaround
        run: |
            git config --global --add safe.directory '*'
            ls -lda . .. .git Makefile

      - name: List git tag
        run: |
          git describe --tags --dirty

      - name: Validate XML
        run: |
          make -C xml validate

      - name: Generate core specs (HTML and PDF)
        run: |
          python3 makeSpec -clean -spec core OUTDIR=out.core -j 5 -O api c env ext cxx4opencl

      - name: Generate core + extension specs (HTML)
        run: |
          python3 makeSpec -clean -spec khr OUTDIR=out.khr -j -O html

      - name: Generate reference pages
        run: |
          python3 makeSpec -spec khr OUTDIR=out.refpages -j 12 -O manhtmlpages
